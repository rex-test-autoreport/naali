// For conditions of distribution and use, see copyright notice in license.txt

#include "StableHeaders.h"
#include "DebugOperatorNew.h"
#include "CoreDefines.h"

#include "PCMAudioFrame.h"
#include "CoreException.h"
#include "MemoryLeakCheck.h"

namespace MumbleVoip
{
    PCMAudioFrame::PCMAudioFrame(int sample_rate, int sample_width, int channels, char* data, int data_size):
            channels_(channels),
            sample_rate_(sample_rate),
            sample_width_(sample_width),
            data_(data),
            data_size_(data_size)
    {
        data_ = new char[data_size];
        memcpy(data_, data, data_size);
    }

     PCMAudioFrame::PCMAudioFrame(PCMAudioFrame* frame):
            channels_(frame->Channels()),
            sample_rate_(frame->SampleRate()),
            sample_width_(frame->SampleWidth()),
            data_(0),
            data_size_(frame->DataSize())
    {
        data_ = new char[frame->DataSize()];
        memcpy(data_, frame->DataPtr(), frame->DataSize());
    }

    PCMAudioFrame::PCMAudioFrame(int sample_rate, int sample_width, int channels, int data_size):
            channels_(channels),
            sample_rate_(sample_rate),
            sample_width_(sample_width),
            data_(0),
            data_size_(data_size)
    {
        data_ = new char[data_size];
    }

    PCMAudioFrame::~PCMAudioFrame()
    {
        SAFE_DELETE_ARRAY(data_);
    }
        
    char* PCMAudioFrame::DataPtr()
    {
        return data_;
    }

    int PCMAudioFrame::SampleAt(int i)
    {
        if (i >= SampleCount() || i < 0)
            throw Exception("Out of bounds");

        switch(sample_width_)
        {
        case 8:
            {
            char* data = (char*)data_;
            return data[i];
            }
        case 16:
            {
            short* data = (short*)data_;
            return data[i];
            }
        default:
            throw Exception("Sample witdth is not supported");
        }
    }

    void PCMAudioFrame::SetSampleAt(int i, int sample)
    {
        switch(sample_width_)
        {
        case 8:
            {
                char* data = (char*)data_;
                data[i] = static_cast<char>(sample);
            }
            break;
        case 16:
            {
                ((short*)data_)[i] = sample;
                //short* data = (short*)data_;
                //data[i] = static_cast<short>(sample);
            }
            break;
        default:
            throw Exception("Sample witdth is not supported");
        }
    }

    int PCMAudioFrame::Channels()
    {
        return channels_;
    }
        
    int PCMAudioFrame::SampleRate()
    {
        return sample_rate_;
    }

    int PCMAudioFrame::SampleWidth()
    {
        return sample_width_;
    }
        
    int PCMAudioFrame::SampleCount()
    {
        return data_size_ * 8 / sample_width_;
    }

    int PCMAudioFrame::LengthMs()
    {
        return 1000 * SampleCount() / sample_rate_;
    }

    int PCMAudioFrame::DataSize()
    {
        return data_size_;
    }

} // namespace MumbleVoip
